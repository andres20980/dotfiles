# Fixes Aplicados para GitOps Perfecto

## FASE 5 - Argo Workflows + Events FUNCIONANDO ‚úÖ

### Problema 1: Argo Events install.yaml vac√≠o
**Causa**: URL de descarga incorrecta
**Fix**: Ya estaba corregido en install.sh (usando namespace.yaml + install.yaml correctos)

### Problema 2: Sensor-controller ignora serviceAccountName
**Causa**: Bug en Argo Events v1.9.7 - el controller NO respeta `spec.serviceAccountName` en el Sensor
**Fix Aplicado**: Parche manual del Deployment generado
```bash
kubectl patch deployment <sensor-deployment> -n argo-events \
  -p '{"spec":{"template":{"spec":{"serviceAccountName":"argo-events-sensor-sa"}}}}'
```
**Pendiente**: Automatizar en install.sh despu√©s de aplicar Sensor

### Problema 3: Workflow-controller sin permisos para WorkflowTemplates
**Causa**: ClusterRoleBinding solo exist√≠a para namespace `argo`, no para `argo-workflows`
**Fix Aplicado**:
```bash
kubectl create clusterrolebinding argo-workflow-controller-binding \
  --clusterrole=argo-cluster-role \
  --serviceaccount=argo-workflows:argo
```
**Pendiente**: Agregar al install.sh despu√©s de instalar Argo Workflows

### Problema 4: DNS incorrecto en Sensor
**Causa**: Sensor usaba `gitea-service.gitea.svc` pero el servicio se llama `gitea.gitea.svc`
**Fix Aplicado**: Corregido en sensor-gitea.yaml
**Pendiente**: Actualizar manifest en /home/asanchez/Code/dotfiles/manifests/

### Problema 5: Workflow size demasiado grande
**Soluci√≥n**: WorkflowTemplates (best practice oficial)
- Creados: git-clone-template, docker-build-template, update-manifests-template
- Workflow reducido de 3,792 a 1,617 bytes (57% reducci√≥n)
**Pendiente**: Agregar WorkflowTemplates a manifests/

### Problema 6: ConfigMap ci-scripts para reducir tama√±o
**Soluci√≥n**: Externalizar scripts bash largos en ConfigMap
- Scripts: git-clone.sh, docker-build-push.sh, update-manifests.sh
**Pendiente**: Agregar ConfigMap a manifests/

## Archivos a actualizar:

1. `/home/asanchez/Code/dotfiles/manifests/gitops-tools/argo-workflows/workflowtemplate-ci.yaml` (NUEVO)
2. `/home/asanchez/Code/dotfiles/manifests/gitops-tools/argo-workflows/configmap-ci-scripts.yaml` (NUEVO)
3. `/home/asanchez/Code/dotfiles/manifests/gitops-tools/argo-events/sensor-gitea.yaml` (ACTUALIZAR URL)
4. `/home/asanchez/Code/dotfiles/install.sh` - Agregar ClusterRoleBinding + parche Sensor

## Estado actual:
- ‚úÖ Workflow ejecuta exitosamente
- ‚úÖ Git-clone completa
- üîÑ Docker-build en progreso
- ‚è≥ Update-manifests pendiente
