# Fixes Aplicados para GitOps Perfecto

## FASE 5 - Argo Workflows + Events FUNCIONANDO ✅

### Problema 1: Argo Events install.yaml vacío
**Causa**: URL de descarga incorrecta
**Fix**: Ya estaba corregido en install.sh (usando namespace.yaml + install.yaml correctos)

### Problema 2: Sensor-controller ignora serviceAccountName
**Causa**: Bug en Argo Events v1.9.7 - el controller NO respeta `spec.serviceAccountName` en el Sensor
**Fix Aplicado**: Parche manual del Deployment generado
```bash
kubectl patch deployment <sensor-deployment> -n argo-events \
  -p '{"spec":{"template":{"spec":{"serviceAccountName":"argo-events-sensor-sa"}}}}'
```
**Pendiente**: Automatizar en install.sh después de aplicar Sensor

### Problema 3: Workflow-controller sin permisos para WorkflowTemplates
**Causa**: ClusterRoleBinding solo existía para namespace `argo`, no para `argo-workflows`
**Fix Aplicado**:
```bash
kubectl create clusterrolebinding argo-workflow-controller-binding \
  --clusterrole=argo-cluster-role \
  --serviceaccount=argo-workflows:argo
```
**Pendiente**: Agregar al install.sh después de instalar Argo Workflows

### Problema 4: DNS incorrecto en Sensor
**Causa**: Sensor usaba `gitea-service.gitea.svc` pero el servicio se llama `gitea.gitea.svc`
**Fix Aplicado**: Corregido en sensor-gitea.yaml
**Pendiente**: Actualizar manifest en /home/asanchez/Code/dotfiles/manifests/

### Problema 5: Workflow size demasiado grande
**Solución**: WorkflowTemplates (best practice oficial)
- Creados: git-clone-template, docker-build-template, update-manifests-template
- Workflow reducido de 3,792 a 1,617 bytes (57% reducción)
**Pendiente**: Agregar WorkflowTemplates a manifests/

### Problema 6: ConfigMap ci-scripts para reducir tamaño
**Solución**: Externalizar scripts bash largos en ConfigMap
- Scripts: git-clone.sh, docker-build-push.sh, update-manifests.sh
**Pendiente**: Agregar ConfigMap a manifests/

## Archivos a actualizar:

1. `/home/asanchez/Code/dotfiles/manifests/gitops-tools/argo-workflows/workflowtemplate-ci.yaml` (NUEVO)
2. `/home/asanchez/Code/dotfiles/manifests/gitops-tools/argo-workflows/configmap-ci-scripts.yaml` (NUEVO)
3. `/home/asanchez/Code/dotfiles/manifests/gitops-tools/argo-events/sensor-gitea.yaml` (ACTUALIZAR URL)
4. `/home/asanchez/Code/dotfiles/install.sh` - Agregar ClusterRoleBinding + parche Sensor

## Estado actual:
- ✅ Workflow ejecuta exitosamente
- ✅ Git-clone completa
- ⚠️ Docker-build pendiente (WorkflowTemplates necesitan volumes en workflow spec)
- ⏳ Update-manifests pendiente

## COMMIT & PUSH REALIZADO ✅
- Commit: d072aa1
- Branch: main
- Archivos integrados:
  - manifests/gitops-tools/argo-workflows/workflowtemplate-ci.yaml
  - manifests/gitops-tools/argo-workflows/configmap-ci-scripts.yaml
  - manifests/gitops-tools/argo-events/sensor-gitea.yaml
  - install.sh (función apply_critical_fixes)

## Próximos pasos:
1. Verificar que workflow completa end-to-end con volumes correctos
2. Testing completo del pipeline CI/CD
3. FASE 6: Argo Image Updater

---

## DEBUGGING SESSION - 2025-10-09 08:52 (UTC+2)

### Problema 7: workflowTemplateRef NO funciona - workflows NO avanzan después de primer step

**Síntomas**:
- Workflow se crea correctamente
- git-clone step ejecuta y completa ✅
- docker-build step NUNCA arranca ❌
- `status.nodes` es NULL (controller NO reconcilia)
- Controller logs NO muestran procesamiento del workflow
- Pods con label "Completed" pero workflow phase "Running"

**Investigación realizada**:

1. **Estructura ClusterWorkflowTemplate con templateRef anidados**:
   - ci-pipeline-template con steps usando templateRef a git-clone-template, docker-build-template
   - Clone ejecuta PERO controller NO actualiza status ni avanza al siguiente step
   - **Hipótesis**: templateRef anidados no se resuelven correctamente

2. **Cambio a inline containers en ClusterWorkflowTemplate**:
   - Eliminados git-clone-template, docker-build-template separados
   - Convertidos a templates inline dentro de ci-pipeline-template
   - **Problema encontrado**: kubectl NO parseaba YAML correctamente
   - Field order incorrecto (inputs antes de container) causaba parsing issues
   - **Fix**: Reordenado a container → inputs
   - Aplicado con `yq eval | kubectl apply` para forzar proper parsing
   - **Resultado**: MISMO problema - workflow atascado después de clone

3. **RBAC - Controller sin permisos para ClusterWorkflowTemplates**:
   - `kubectl auth can-i get clusterworkflowtemplate --as=system:serviceaccount:argo-workflows:argo` → NO
   - ClusterRoleBinding estaba bindeado a SA `argo` en namespace `argo` (incorrecto)
   - Controller deployment usa SA `argo` en namespace `argo-workflows`
   - **Fix**: `kubectl patch clusterrolebinding argo-clusterworkflowtemplate-role-binding` (cambiar namespace)
   - **Verificado**: `kubectl auth can-i` → YES
   - **Resultado**: MISMO problema persiste

4. **Cambio a workflows inline (sin workflowTemplateRef)**:
   - Eliminado workflowTemplateRef del sensor
   - Sensor ahora genera workflows con templates inline completos
   - Controller reiniciado
   - **Resultado**: MISMO problema - status.nodes NULL, solo clone ejecuta

5. **Controller instanceID label**:
   - Workflows NO tenían label `workflows.argoproj.io/controller-instanceid: default`
   - Controller filtra workflows por este label en logs
   - **Fix**: Agregado label a workflow test
   - **Resultado**: MISMO problema persiste

6. **Controller NAMESPACE env var faltante**:
   - Controller deployment NO tenía env var `NAMESPACE`
   - **Fix**: `kubectl patch deployment workflow-controller` (agregado NAMESPACE env var)
   - Controller reiniciado
   - **Resultado**: Pendiente test

**Estado actual**:
- Controller v3.7.2 running
- Controller config: instanceID=default, namespace=argo-workflows
- RBAC OK para workflows y ClusterWorkflowTemplates
- Workflows inline con templates completos aplicados
- Controller tiene NAMESPACE env var ahora
- **PROBLEMA CRÍTICO**: Controller NO reconcilia workflows, status permanece NULL
- Clone pods ejecutan (lo que indica algún proceso crea pods) pero workflow status NO se actualiza

**Archivos modificados**:
- `manifests/gitops-tools/argo-workflows/workflowtemplate-ci.yaml`: ClusterWorkflowTemplate con inline containers
- `/tmp/sensor-inline.yaml`: Sensor con workflow inline completo (NO workflowTemplateRef)
- ClusterRoleBinding `argo-clusterworkflowtemplate-role-binding`: namespace corregido a argo-workflows
- Deployment `workflow-controller`: Agregado NAMESPACE env var

**Próximo paso**: Consultar documentación oficial Argo Workflows

---

## BLOQUEO CRÍTICO - Controller NO procesa workflows

**Problema**: Controller running pero NO reconcilia workflows nuevos
- Pods se crean (clone ejecuta)
- Workflow status permanece NULL
- Controller logs NO muestran procesamiento de workflows
- Solo workflows existentes ANTES del restart son procesados

**Tests realizados**:
1. ✅ ClusterRoleBinding namespace corregido (argo-workflows)
2. ✅ NAMESPACE env var agregado
3. ✅ --namespaced + --managed-namespace probado
4. ✅ Volver a cluster-wide mode
5. ✅ Clean restart sin workflows existentes
6. ✅ Workflow simple hello-world test

**Todos fallan igual**: Controller NO procesa nuevos workflows

**Conclusión**: Problema fundamental con controller v3.7.2 o instalación

### 2025-10-09 11:20 - Flags namespaced en workflow-controller

**Hallazgo**: ArgoCD seguía reconciliando el Deployment `workflow-controller` sin los flags `--namespaced` y `--managed-namespace`, y además faltaba `POD_NAMESPACE`.

**Corrección**:
- Actualizado `manifests/gitops-tools/argo-workflows/install.yaml` (dotfiles) y `/home/asanchez/gitops-repos/gitops-tools/argo-workflows/install.yaml` con los nuevos argumentos (`--namespaced`, `--managed-namespace`) y variables de entorno.
- Refactorizado `ConfigMap workflow-controller-configmap` manteniendo `instanceID` (sin `workflowNamespaces`, no soportado en 3.7.2).
- Ejecutado `kubectl apply --server-side --force-conflicts -f argo-workflows/install.yaml` (repo vivo) para alinear RBAC y configmap.
- Pending: esperar a que ArgoCD sincronice la nueva versión o forzar sync manual para que los args se persistan definitivamente.

**Validación**:
- `kubectl diff -f argo-workflows/install.yaml` muestra las diferencias esperadas (flags + env + configmap sin campos no soportados).
- `kubectl get deploy workflow-controller -o yaml` sigue mostrando los args antiguos → indica que ArgoCD aún no ha reconciliado con el commit actualizado.
- Tras `git push` a Gitea, ArgoCD sincroniza y el Deployment contiene los nuevos argumentos.
- Se eliminó `--workflow-namespace` tras comprobar que provoca `unknown flag` en v3.7.2.
- También se retiró `workflowNamespaces` del ConfigMap al detectar error de parseo.
- Workflow manual `demo-app-ci-manual` lanzado para validar reconciliación (aún en análisis de paso Kaniko).
